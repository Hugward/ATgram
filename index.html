<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ATgram Messenger</title>
  <style>
    :root {
      --bg-color: #182229;
      --secondary-bg: #2a3942;
      --accent-color: #0088cc;
      --text-color: #e9edef;
      --secondary-text: #8696a0;
      --message-out-bg: #005c4b;
      --message-in-bg: #2a3942;
      --border-color: #303d45;
      --error-color: #ff6b6b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Auth Panel */
    .auth-panel {
      max-width: 400px;
      width: 90%;
      margin: auto;
      padding: 30px;
      background-color: var(--secondary-bg);
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    .auth-panel h1 {
      margin-bottom: 24px;
      color: var(--text-color);
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .auth-input {
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-size: 16px;
      width: 100%;
    }

    .auth-btn {
      padding: 12px;
      border: none;
      border-radius: 8px;
      background-color: var(--accent-color);
      color: white;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      width: 100%;
    }

    .auth-btn:hover {
      background-color: #0078b4;
    }

    .auth-btn.secondary {
      background-color: var(--secondary-bg);
      color: var(--accent-color);
    }

    .error-message {
      color: var(--error-color);
      font-size: 14px;
      margin-top: 8px;
      min-height: 20px;
    }

    /* App Container */
    .app-container {
      display: none;
      height: 100%;
      width: 100%;
    }

    .app-content {
      display: flex;
      height: 100%;
    }

    /* Sidebar */
    .sidebar {
      width: 350px;
      background-color: var(--secondary-bg);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    /* Header */
    .header {
      padding: 12px 16px;
      background-color: var(--secondary-bg);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
    }

    .header-title {
      font-size: 18px;
      font-weight: 500;
    }

    /* User List */
    .user-list {
      flex: 1;
      overflow-y: auto;
    }

    .user-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .user-item:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .user-item.active {
      background-color: rgba(0, 136, 204, 0.1);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--accent-color);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-weight: 500;
      color: white;
    }

    /* Messages */
    .messages-container {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background-color: var(--bg-color);
      background-image: 
        linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 20px 20px;
    }

    .message {
      max-width: 70%;
      margin-bottom: 16px;
      padding: 8px 12px;
      border-radius: 8px;
      position: relative;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-out {
      background-color: var(--message-out-bg);
      margin-left: auto;
      border-top-right-radius: 0;
    }

    .message-in {
      background-color: var(--message-in-bg);
      margin-right: auto;
      border-top-left-radius: 0;
    }

    .message-sender {
      font-weight: 500;
      margin-bottom: 4px;
      display: block;
      font-size: 14px;
    }

    .message-text {
      line-height: 1.4;
      margin-bottom: 4px;
    }

    .message-time {
      font-size: 11px;
      color: var(--secondary-text);
      text-align: right;
    }

    .empty-chat {
      text-align: center;
      padding-top: 40%;
      color: var(--secondary-text);
    }

    /* Input Area */
    .input-area {
      padding: 12px 16px;
      background-color: var(--secondary-bg);
      border-top: 1px solid var(--border-color);
      display: none;
    }

    .message-input {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 20px;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-size: 16px;
      resize: none;
      max-height: 120px;
      outline: none;
      line-height: 1.4;
    }

    .send-btn {
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .send-btn:hover {
      background-color: #0078b4;
    }

    .send-btn:disabled {
      background-color: var(--secondary-text);
      cursor: not-allowed;
    }

    /* Loading */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Alert */
    .alert {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--error-color);
      color: white;
      padding: 15px;
      border-radius: 5px;
      z-index: 1000;
      max-width: 80%;
      text-align: center;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { top: -50px; opacity: 0; }
      to { top: 20px; opacity: 1; }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
      }

      .app-container.sidebar-hidden .sidebar {
        display: none;
      }

      .app-container.sidebar-hidden .chat-container {
        display: flex;
      }
    }
  </style>
</head>
<body>
  <!-- Auth Panel -->
  <div id="authPanel" class="auth-panel">
    <h1>ATgram</h1>
    <div id="loginForm" class="auth-form">
      <input type="text" id="loginUsername" class="auth-input" placeholder="–õ–æ–≥–∏–Ω" autocomplete="username">
      <input type="password" id="loginPassword" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
      <button id="loginBtn" class="auth-btn">
        <span id="loginBtnText">–í–æ–π—Ç–∏</span>
        <div id="loginSpinner" class="loading" style="display: none;"></div>
      </button>
      <button id="showRegisterBtn" class="auth-btn secondary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      <div id="loginError" class="error-message"></div>
    </div>
    
    <div id="registerForm" class="auth-form" style="display: none;">
      <input type="text" id="regUsername" class="auth-input" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" autocomplete="username">
      <input type="password" id="regPassword" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="new-password">
      <input type="password" id="regConfirmPassword" class="auth-input" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="new-password">
      <button id="registerBtn" class="auth-btn">
        <span id="registerBtnText">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>
        <div id="registerSpinner" class="loading" style="display: none;"></div>
      </button>
      <button id="showLoginBtn" class="auth-btn secondary">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
      <div id="regError" class="error-message"></div>
    </div>
  </div>
  
  <!-- Main App -->
  <div id="appContainer" class="app-container">
    <div class="app-content">
      <div class="sidebar">
        <div class="header">
          <div class="header-title">–ß–∞—Ç—ã</div>
        </div>
        <div class="user-list" id="usersList">
          <!-- Users will be loaded here -->
        </div>
      </div>
      
      <div class="chat-container">
        <div class="header">
          <button id="backButton" class="send-btn" style="margin-right: 12px; display: none;">‚Üê</button>
          <div class="header-title" id="currentChatTitle">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
        </div>
        
        <div class="messages-container" id="messages">
          <div class="empty-chat">
            –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ
          </div>
        </div>
        
        <div class="input-area" id="inputArea">
          <textarea id="messageInput" class="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
          <button id="sendBtn" class="send-btn" disabled>‚û§</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyaCu6soc0MJVQ1tB3rr_U_7AWvJEvjJg-3N4vlmVd7udiJjAM5UFNTP2dkOKFI9o3N/exec';
    let currentUser = null;
    let currentChat = null;
    let refreshInterval;
    let isSending = false;

    // DOM Elements
    const authPanel = document.getElementById('authPanel');
    const appContainer = document.getElementById('appContainer');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const loginBtn = document.getElementById('loginBtn');
    const loginBtnText = document.getElementById('loginBtnText');
    const loginSpinner = document.getElementById('loginSpinner');
    const registerBtn = document.getElementById('registerBtn');
    const registerBtnText = document.getElementById('registerBtnText');
    const registerSpinner = document.getElementById('registerSpinner');
    const showRegisterBtn = document.getElementById('showRegisterBtn');
    const showLoginBtn = document.getElementById('showLoginBtn');
    const loginError = document.getElementById('loginError');
    const regError = document.getElementById('regError');
    const usersList = document.getElementById('usersList');
    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const currentChatTitle = document.getElementById('currentChatTitle');
    const inputArea = document.getElementById('inputArea');
    const backButton = document.getElementById('backButton');

    // Event Listeners
    showRegisterBtn.addEventListener('click', () => {
      loginForm.style.display = 'none';
      registerForm.style.display = 'block';
      loginError.textContent = '';
    });

    showLoginBtn.addEventListener('click', () => {
      registerForm.style.display = 'none';
      loginForm.style.display = 'block';
      regError.textContent = '';
    });

    loginBtn.addEventListener('click', handleLogin);
    registerBtn.addEventListener('click', handleRegister);
    sendBtn.addEventListener('click', sendMessage);
    
    messageInput.addEventListener('input', () => {
      sendBtn.disabled = messageInput.value.trim() === '' || isSending;
      adjustTextareaHeight();
    });

    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!sendBtn.disabled) {
          sendMessage();
        }
      }
    });

    backButton.addEventListener('click', () => {
      appContainer.classList.remove('sidebar-hidden');
    });

    // Functions
    function adjustTextareaHeight() {
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
    }

    function showAlert(message, duration = 5000) {
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert';
      alertDiv.textContent = message;
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, duration);
    }

    async function safeFetch(url, options = {}) {
      try {
        // Try direct fetch first
        const response = await fetch(url, options);
        if (response.ok) return response;
        
        return response;
      } catch (error) {
        console.error('Fetch error:', error);
        throw error;
      }
    }

    async function handleLogin() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value.trim();

      if (!username || !password) {
        loginError.textContent = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å';
        return;
      }

      try {
        loginBtnText.style.display = 'none';
        loginSpinner.style.display = 'block';
        loginBtn.disabled = true;

        const response = await safeFetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'login',
            username: username,
            password: password
          })
        });
        
        const data = await response.json();

        if (data.status === 'success') {
          currentUser = { username: data.data.username };
          authPanel.style.display = 'none';
          appContainer.style.display = 'flex';
          
          startAutoRefresh();
          await updateUsersList();
          loadInitialChat();
        } else {
          loginError.textContent = data.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
        }
      } catch (error) {
        console.error('Login error:', error);
        loginError.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
        showAlert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
      } finally {
        loginBtnText.style.display = 'block';
        loginSpinner.style.display = 'none';
        loginBtn.disabled = false;
      }
    }

    async function handleRegister() {
      const username = document.getElementById('regUsername').value.trim();
      const password = document.getElementById('regPassword').value.trim();
      const confirmPassword = document.getElementById('regConfirmPassword').value.trim();

      if (!username || !password) {
        regError.textContent = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å';
        return;
      }

      if (password !== confirmPassword) {
        regError.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
        return;
      }

      try {
        registerBtnText.style.display = 'none';
        registerSpinner.style.display = 'block';
        registerBtn.disabled = true;

        const response = await safeFetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'register',
            username: username,
            password: password
          })
        });
        
        const data = await response.json();

        if (data.status === 'success') {
          showAlert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.');
          registerForm.style.display = 'none';
          loginForm.style.display = 'block';
          document.getElementById('loginUsername').value = username;
          document.getElementById('loginPassword').value = '';
          regError.textContent = '';
        } else {
          regError.textContent = data.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
        }
      } catch (error) {
        console.error('Registration error:', error);
        regError.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
        showAlert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
      } finally {
        registerBtnText.style.display = 'block';
        registerSpinner.style.display = 'none';
        registerBtn.disabled = false;
      }
    }

    function startAutoRefresh() {
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(() => {
        updateUsersList();
        if (currentChat) loadMessages();
      }, 2000);
    }

    async function updateUsersList() {
      try {
        const response = await safeFetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'getUsers',
            currentUser: currentUser.username
          })
        });
        
        const data = await response.json();
        if (data.status === 'success') renderUsersList(data.data.users);
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    function renderUsersList(users) {
      usersList.innerHTML = '';
      
      // General chat
      const generalChat = document.createElement('div');
      generalChat.className = `user-item ${currentChat?.type === 'general' ? 'active' : ''}`;
      generalChat.innerHTML = `
        <div class="user-avatar">üë•</div>
        <div class="user-info">
          <div class="user-name">–û–±—â–∏–π —á–∞—Ç</div>
        </div>
      `;
      generalChat.addEventListener('click', () => {
        currentChat = { type: 'general' };
        currentChatTitle.textContent = '–û–±—â–∏–π —á–∞—Ç';
        loadMessages();
        updateActiveUserItem();
        if (window.innerWidth <= 768) appContainer.classList.add('sidebar-hidden');
      });
      usersList.appendChild(generalChat);
      
      // Users
      users.forEach(user => {
        const userElement = document.createElement('div');
        userElement.className = `user-item ${currentChat?.recipient === user ? 'active' : ''}`;
        userElement.innerHTML = `
          <div class="user-avatar">${user.charAt(0).toUpperCase()}</div>
          <div class="user-info">
            <div class="user-name">${user}</div>
          </div>
        `;
        userElement.addEventListener('click', () => {
          currentChat = { type: 'private', recipient: user };
          currentChatTitle.textContent = user;
          loadMessages();
          updateActiveUserItem();
          if (window.innerWidth <= 768) appContainer.classList.add('sidebar-hidden');
        });
        usersList.appendChild(userElement);
      });
    }

    function updateActiveUserItem() {
      const userItems = document.querySelectorAll('.user-item');
      userItems.forEach(item => item.classList.remove('active'));

      if (currentChat) {
        if (currentChat.type === 'general') {
          userItems[0]?.classList.add('active');
        } else {
          const recipient = currentChat.recipient;
          Array.from(userItems).find(item => 
            item.querySelector('.user-name')?.textContent === recipient
          )?.classList.add('active');
        }
      }
    }

    function loadInitialChat() {
      currentChat = { type: 'general' };
      currentChatTitle.textContent = '–û–±—â–∏–π —á–∞—Ç';
      loadMessages();
      inputArea.style.display = 'flex';
      backButton.style.display = 'none';
    }

    async function loadMessages() {
      if (!currentUser || !currentChat) return;

      try {
        const response = await safeFetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'getMessages',
            currentUser: currentUser.username,
            roomType: currentChat.type,
            recipient: currentChat.type === 'private' ? currentChat.recipient : undefined
          })
        });
        
        const data = await response.json();

        if (data.status === 'success') {
          renderMessages(data.data.messages);
          inputArea.style.display = 'flex';
          backButton.style.display = window.innerWidth <= 768 ? 'block' : 'none';
        }
      } catch (error) {
        console.error('Error loading messages:', error);
      }
    }

    function renderMessages(messages) {
      messagesContainer.innerHTML = '';
      
      if (!messages || messages.length === 0) {
        messagesContainer.innerHTML = `
          <div class="empty-chat">
            –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
          </div>
        `;
        return;
      }

      messages.forEach(msg => {
        const isCurrentUser = msg.sender === currentUser.username;
        const messageElement = document.createElement('div');
        messageElement.className = `message ${isCurrentUser ? 'message-out' : 'message-in'}`;
        
        const timestamp = msg.timestamp ? new Date(msg.timestamp) : new Date();
        const timeString = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        messageElement.innerHTML = `
          <span class="message-sender">${isCurrentUser ? '–í—ã' : msg.sender}</span>
          <div class="message-text">${msg.message || msg.content}</div>
          <div class="message-time">${timeString}</div>
        `;
        
        messagesContainer.appendChild(messageElement);
      });
      
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!currentUser || !message || isSending) return;

      isSending = true;
      sendBtn.disabled = true;
      
      try {
        const response = await safeFetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'sendMessage',
            sender: currentUser.username,
            message: message,
            roomType: currentChat.type,
            recipient: currentChat.recipient
          })
        });
        
        const data = await response.json();

        if (data.status === 'success') {
          messageInput.value = '';
          messageInput.style.height = 'auto';
          sendBtn.disabled = true;
          loadMessages();
        } else {
          showAlert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      } catch (error) {
        console.error('Error sending message:', error);
        showAlert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
      } finally {
        isSending = false;
      }
    }

    // Responsive adjustments
    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        appContainer.classList.remove('sidebar-hidden');
      }
    });
  </script>
</body>
</html>